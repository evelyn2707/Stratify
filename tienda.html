<!-- tienda.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stratify Store</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#ffffff">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>

        body { background:#0F141F; }

        .product-img {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }
        .cart-item-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
        .thumb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        .thumb {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
        #btnPaquetePersonalizado {
            background: transparent;
            color: #17ff3e;
            border: 2px solid #17ff3e;
        }

        #btnPaquetePersonalizado:hover {
            background: #17ff3e;
            color: #ffffff;
        }

        .btn-custom {
        width: 100%;
        height: 50px;
        margin: 8px 16px;
        border: 2px solid transparent;
        border-radius: 6px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        }

        /* Colores personalizados */
        .btn-carrito {
            background: #b330ff;
            color: white;
            border-color: #b330ff;
        }
        .btn-carrito:hover {
            background: transparent;
            color: #b330ff;
        }

        .btn-solicitudes {
            background: #17ff3e;
            color: white;
            border-color: #17ff3e;
        }
        .btn-solicitudes:hover {
            background: transparent;
            color: #17ff3e;
        }

        .btn-perfil {
            background: transparent;
            color: #009bfa;
            border-color: #009bfa;
        }
        .btn-perfil:hover {
            background: #009bfa;
            color: white;
        }
        .custom-reservar-btn {
            background-color: transparent !important;   /* fondo base tipo outline */
            border: 2px solid #b330ff !important;       /* color del borde */
            color: #b330ff !important;                  /* color del texto */
            border-radius: 10px;                        /* opcional */
            padding: 10px 15px;
            transition: 0.2s ease-in-out;
        }

        .custom-reservar-btn:hover {
            background-color: #b330ff !important;       /* color al pasar mouse */
            color: white !important;
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-light border-bottom sticky-top" style="background:#0f141f;">
        <div class="container d-flex align-items-center">

            <span class="navbar-brand mb-0 h1" style="color: #eb01c2;"> Stratify Store</span>
            <!-- Barra de b√∫squeda centrada -->
            <form class="flex-grow-1 d-flex align-items-center" role="search" style="position: relative;">
                <i class="bi bi-search"
                style="position: absolute; left: 10px; color:#b330ff; font-size: 1.2rem;"></i>

                <input id="searchInput"
                    class="form-control ps-4"
                    type="search"
                    placeholder="  Buscar servicio..."
                    aria-label="Buscar"
                    style="background: transparent; color:white; border:1px solid #b330ff; padding-left: 35px;">

                        <style>
                            #searchInput::placeholder {
                                color: #7e7e7e; /* color del placeholder */
                                opacity: 1;      /* para que se vea bien */
                            }
                        </style>

                <select id="filterTipo" class="form-select ms-2" style="width: auto; background: #0f141f; color:white; border:1px solid #b330ff;">
                    <option value="todos" style="color: #009bfa;" selected>Todos</option>
                    <option value="producto" style="color: #b330ff;">Servicios</option>
                    <option value="paquete" style="color: #17ff3e;">Paquetes</option>
                </select>
            </form>
            <!-- Bot√≥n hamburguesa -->
            <button class="btn btn-outline-secondary ms-2"
                    type="button"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#menuOffcanvas">
                <i class="bi bi-list" style="font-size:1.5rem;"></i>
            </button>
        </div>
    </nav>

    <!-- MEN√ö HAMBURGUESA -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="menuOffcanvas"
        style="background:#0f141f; border-left:2px solid #17ff3e; color:white;">

        <div class="offcanvas-header">
            <h5 style="color:#eb01c2;">Men√∫</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div id="userInfo" class="p-3 mb-2" style="border-bottom: 1px solid #555; color:white;">
            <p id="menuNombre" class="mb-1" style="font-weight:bold;">Nombre</p>
            <p id="menuTelefono" class="mb-0" style="font-size: 0.9rem;">Telefono</p>
            <p id="menuCorreo" class="mb-0" style="font-size:0.9rem;">correo@ejemplo.com</p>
        </div>

        <button 
            class="btn-custom btn-carrito position-relative" 
            data-bs-toggle="offcanvas" 
            data-bs-target="#cartOffcanvas">
            <i class="bi bi-cart3"></i> Mi Carrito
            <span id="cart-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
        </button>
        <button 
            class="btn-custom btn-solicitudes position-relative" 
            data-bs-toggle="offcanvas" 
            data-bs-target="#solicitudesOffcanvas">
            <i class="bi bi-card-checklist"></i> Mis Solicitudes
        </button>
                <div>
            <button class="btn-custom btn-perfil position-relative" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle"></i> Mi Perfil
            </button>

            <ul class="dropdown-menu dropdown-menu-dark w-100">
                <li>
                    <button class="dropdown-item" style="color: #17ff3e;" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" style="color: #eb01c2;" onclick="eliminarPerfil()">
                        <i class="bi bi-person-x"></i> Eliminar perfil
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="container mt-4">
        <div id="paquetePersonalizadoContainer" class="mt-3 mb-4 text-center"></div>
        <div id="productos" class="row"></div>
    </div>


    <!-- Offcanvas Carrito -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" style="background:#0f141f; color:white; border: 2px solid #b330ff; color: white;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" style="color:#b330ff;">Carrito de Compras</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="carrito-contenido">
                <ul id="lista-carrito" class="list-group mb-3"></ul>
                <div class="border-top pt-3">
                    <p class="h5"><strong>Total:</strong> $<span id="total">0</span></p>
                    <div class="d-grid gap-2">
                        <button id="limpiar-carrito" class="btn" style="background:#eb01c2; color:white;">
                            <i class="bi bi-trash"></i> Vaciar Carrito
                        </button>
                        <button id="pagar" class="btn btn-success" style="background:#17ff3e; color:white;">
                            <i class="bi bi-credit-card"></i> Pagar Ahora
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--Modal paquete perosnalizado-->
    <div class="modal fade" id="personalizadoModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background:#0f141f; color:white;">
          <div class="modal-header">
            <h5 class="modal-title" style="color: #eb01c2;">Paquete Personalizado</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <form id="personalizadoForm">
            <div class="modal-body">
              <div class="row g-3">
                <p style="color: #b330ff;">Datos personales y de contacto</p>
                <div class="col-md-6">
                  <label class="form-label">Nombre*</label>
                  <input id="persNombre" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tel√©fono *</label>
                  <input type="tel" id="persTelefono" class="form-control" 
                        pattern="[0-9]{10}" maxlength="10" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Correo *</label>
                  <input type="email" id="persCorreo" class="form-control" required>
                </div>
                <p style="color: #17ff3e;">Datos de tu empresa</p>
                <div class="col-md-6">
                  <label class="form-label">Nombre de la empresa*</label>
                  <input id="empNombre" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">√Årea de la empresa *</label>
                  <select id="empArea" class="form-control" required>
                      <option value="" disabled selected>Seleccione una opci√≥n</option>
                      <option value="Alimentos y Bebidas">Alimentos y Bebidas</option>
                      <option value="Joyer√≠a">Joyer√≠a</option>
                      <option value="Educaci√≥n">Educaci√≥n</option>
                      <option value="Autopartes">Autopartes</option>
                      <option value="Moda y Ropa">Moda y Ropa</option>
                      <option value="Belleza y Cosm√©ticos">Belleza y Cosm√©ticos</option>
                      <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                      <option value="Bienes Ra√≠ces">Bienes Ra√≠ces</option>
                      <option value="Salud y Fitness">Salud y Fitness</option>
                      <option value="Servicios Profesionales">Servicios Profesionales</option>
                      <option value="Otro">Otro</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">Descripci√≥n de las necesidades de la empresa*</label>
                  <textarea id="empDescripcion" class="form-control" rows="3" required></textarea>
                </div>
                <p style="color: #009bfa;">Personaliza tu paquete</p>
                <div class="col-12">
                  <label class="form-label">Servicios requeridos*</label>
                  <div id="servPersonalizados" class="form-check-container" style="max-height:200px; overflow-y:auto; border:1px solid #555; padding:0.5rem; border-radius:0.5rem;"></div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Otros servicios</label>
                  <input id="servOtro" class="form-control">
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Cancelar</button>
              <button class="btn" style="background:#17ff3e; color:white;" type="submit" id="submitBtnPaquete">
                <span class="spinner-border spinner-border-sm d-none" id="submitSpinnerPaquete"></span>
                Solicitar Paquete
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
        // Proteger acceso
        const user = localStorage.getItem("stratifyUser");
        if (!user) {
            window.location.href = "login.html";
        }

        function logout() {
            localStorage.removeItem("stratifyUser");
            window.location.href = "index.html";
        }
        
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">

        // Configuraci√≥n Firebase //muy importante cambies estos datos con tus propias claves
        const firebaseConfig = {
            apiKey: "AIzaSyDlyA18XufNSSnF0pv5pc1lQIRNXkLAJAY",
            authDomain: "stratify-5cbc4.firebaseapp.com",
            projectId: "stratify-5cbc4",
            storageBucket: "stratify-5cbc4.firebasestorage.app",
            messagingSenderId: "843493852132",
            appId: "1:843493852132:web:e08e49ba0963e0ae73bdf1",
            measurementId: "G-NSHKMCZ95V"
        };
        import { 
             getAuth, deleteUser, reauthenticateWithCredential, EmailAuthProvider 
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, query, orderBy, doc, getDoc,deleteDoc, addDoc
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const auth = getAuth(app);
        let deferredPrompt;

        window.eliminarPerfil = async function() {
            if (!confirm("¬øSeguro que deseas eliminar tu perfil? Esta acci√≥n no se puede deshacer.")) return;

            try {
                const currentUser = auth.currentUser;
                const userStorage = JSON.parse(localStorage.getItem("stratifyUser"));

                if (!currentUser || !userStorage) {
                    alert("No se pudo obtener el usuario actual.");
                    return;
                }

                // Pedir contrase√±a para reautenticaci√≥n
                const password = prompt("Para eliminar tu cuenta, ingresa tu contrase√±a:");
                if (!password) {
                    alert("Eliminaci√≥n cancelada. Debes ingresar tu contrase√±a.");
                    return;
                }

                // Reautenticar
                const credential = EmailAuthProvider.credential(currentUser.email, password);
                await reauthenticateWithCredential(currentUser, credential);

                // Eliminar documento en Firestore
                await deleteDoc(doc(db, "usuarios", userStorage.uid));

                // Eliminar usuario de Firebase Auth
                await deleteUser(currentUser);

                // Limpiar localStorage y redirigir
                localStorage.removeItem("stratifyUser");
                alert("Tu cuenta ha sido eliminada correctamente.");
                window.location.href = "index.html";

            } catch (error) {
                console.error("Error eliminando perfil:", error);
                if (error.code === "auth/wrong-password") {
                    alert("Contrase√±a incorrecta. No se pudo eliminar la cuenta.");
                } else if (error.code === "auth/requires-recent-login") {
                    alert("Debes iniciar sesi√≥n de nuevo antes de eliminar tu cuenta.");
                } else {
                    alert("Ocurri√≥ un error al eliminar la cuenta. Revisa la consola.");
                }
            }
        }

        // HABILITAR PERSISTENCIA OFFLINE DE FIRESTORE
        import { enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        enableIndexedDbPersistence(db)
          .then(() => {
            console.log("Persistencia offline habilitada - Tienda");
          })
          .catch((err) => {
            console.log("Persistencia no disponible en este contexto");
          });

        const productosDiv = document.getElementById("productos");
        const carritoUl = document.getElementById("lista-carrito");
        const totalSpan = document.getElementById("total");
        const pagarBtn = document.getElementById("pagar");
        const cartBadge = document.getElementById("cart-badge");
        const limpiarBtn = document.getElementById("limpiar-carrito");
        let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        let productosData = [];

        // FUNCI√ìN PARA MOSTRAR ALERTAS
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertDiv.style.zIndex = '1060';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // DETECCI√ìN DE CONEXI√ìN MEJORADA
        function updateOnlineStatus() {
            if (!navigator.onLine) {
                showAlert("Modo offline activado", "warning");
                // Verificar si tenemos datos cacheados
                const cache = localStorage.getItem('productosCache');
                if (!cache) {
                    showAlert("Con√©ctate primero a internet para cargar productos", "danger");
                }
            } else {
                showAlert("Conectado - Sincronizando", "success");
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        //busqueda
        document.getElementById("searchInput").addEventListener("input", filtrarProductos);
        document.getElementById("filterTipo").addEventListener("change", filtrarProductos);

        function filtrarProductos() {
            const texto = document.getElementById("searchInput").value.toLowerCase().trim();
            const tipo = document.getElementById("filterTipo").value;

            const filtrados = productosData.filter(p => {
                const coincideTexto = p.nombre.toLowerCase().includes(texto) ||
                                    p.descripcion.toLowerCase().includes(texto) ||
                                    (p.responsable && p.responsable.toLowerCase().includes(texto)) ||
                                    (p.servicios && Array.isArray(p.servicios) && p.servicios.join(', ').toLowerCase().includes(texto));
                const coincideTipo = tipo === "todos" || p.tipo === tipo;

                return coincideTexto && coincideTipo;
            });

            renderProductos(filtrados);
        }

        const listaSolicitudesUl = document.getElementById("lista-solicitudes");

        // Funci√≥n para obtener nombre de servicios por id
        async function obtenerNombreServicios(ids) {
            if (!Array.isArray(ids)) return [];
            const nombres = [];
            for (const id of ids) {
                try {
                    const snap = await getDoc(doc(db, "productos", id));
                    if (snap.exists()) nombres.push(snap.data().nombre);
                    else nombres.push("Servicio no encontrado");
                } catch {
                    nombres.push("Error");
                }
            }
            return nombres;
        }

        // Cargar solicitudes en tiempo real
        const solicitudesRef = collection(db, "solicitudes");
        const qSolicitudes = query(solicitudesRef, orderBy("fecha", "desc"));

       const currentUser = JSON.parse(localStorage.getItem("stratifyUser"));

        onSnapshot(qSolicitudes, async (snapshot) => {
            listaSolicitudesUl.innerHTML = ""; // limpiar lista
            const userDocs = snapshot.docs.filter(docu => docu.data().uid === currentUser.uid); // <-- Filtrar por usuario

            if (userDocs.length === 0) {
                listaSolicitudesUl.innerHTML = `<li class="list-group-item text-center text-muted" style="color:white;">No tienes solicitudes</li>`;
                return;
            }

            for (const docu of userDocs) {
                const s = docu.data();
                const serviciosNombres = await obtenerNombreServicios(s.serviciosRequeridos || []);

                const li = document.createElement("li");
                li.className = "list-group-item mb-2";
                li.style.background = "#1a1f2c";
                li.style.borderLeft = "5px solid #17ff3e";
                li.style.color = "white"; // texto en blanco

               // Establecer color del estatus usando mapeo
                const estatusColors = {
                    "enviada": "#eb01c2",     // rosa
                    "en proceso": "#009bfa",  // azul
                    "finalizada": "#17ff3e"   // verde
                };

                // Normalizar el estatus (min√∫sculas y quitar espacios)
                const estatus = (s.estatus || "").toLowerCase().trim();

                // Obtener color seg√∫n estatus
                const colorEstatus = estatusColors[estatus] || "white"; // por defecto blanco

                li.innerHTML = `
                    <strong>${s.nombrePersona}</strong> (${s.fecha.toDate().toLocaleString()})<br>
                    <em>${s.nombreEmpresa} - ${s.areaEmpresa}</em><br>
                    Servicios: ${serviciosNombres.join(', ')}${s.otrosServicios ? ', ' + s.otrosServicios : ''}<br>
                    Estatus: <span style="color:${colorEstatus}; font-weight:bold;">${s.estatus}</span>
                `;

                listaSolicitudesUl.appendChild(li);
            }
        });
        
        // Cargar datos del usuario en el men√∫ hamburguesa
        async function cargarDatosMenu() {
            const userStorage = JSON.parse(localStorage.getItem("stratifyUser"));
            if (!userStorage || !userStorage.uid) return;

            const userDocRef = doc(db, "usuarios", userStorage.uid);
            try {
                const userSnap = await getDoc(userDocRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    document.getElementById("menuNombre").textContent = userData.nombre || "Sin nombre";
                    document.getElementById("menuTelefono").textContent = userData.telefono || "Sin telefono";
                    document.getElementById("menuCorreo").textContent = userData.email || "Sin correo";
                } else {
                    console.log("No existe el documento del usuario en Firestore");
                }
            } catch (error) {
                console.error("Error al cargar datos del usuario:", error);
            }
        }

        // Llamar la funci√≥n al cargar la p√°gina
        cargarDatosMenu();

        // Cargar productos desde Firestore CON SOPORTE OFFLINE
        let productosCache = [];
        let paquetesCache = [];

        async function cargarProductos() {
            // Primero intentar cargar desde cache si est√° offline
            const cache = localStorage.getItem('productosCache');
            if (cache && !navigator.onLine) {
                productosData = JSON.parse(cache);
                renderProductos(productosData);
                showAlert("Modo offline - Datos cacheados", "info");
                return;
            }

            const productosRef = collection(db, 'productos');
            const paquetesRef = collection(db, 'paquetes');

            const qProductos = query(productosRef, orderBy('createdAt', 'desc'));
            const qPaquetes = query(paquetesRef, orderBy('createdAt', 'desc'));

            // Observadores independientes
            onSnapshot(qProductos, snapshotProductos => {
                const productosList = snapshotProductos.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        id: doc.id,
                        tipo: 'producto',
                        nombre: data.nombre || 'Sin nombre',
                        precio: Number(data.precio) || 0,
                        descripcion: data.descripcion || 'Sin descripci√≥n',
                        ubicacion: data.ubicacion || 'Sin definir',
                        imagenes: data.imagenes || [],
                        imagenUrl: data.imagenUrl || data.imagenes?.[0] || 'https://via.placeholder.com/300x200?text=Imagen+No+Disponible',
                        responsable: data.responsable || 'Sin responsable',
                        stock: Number(data.stock) || 0,
                        createdAt: data.createdAt || null,
                        agenda: data.agenda === true // <-- A√ëADIDO: bandera de agenda
                    };
                });

                productosCache = productosList;
                productosData = mergeAndSort(productosCache, paquetesCache);
                renderProductos(productosData);
                localStorage.setItem('productosCache', JSON.stringify(productosData));
            });

            // Cargar servicios (productos) en el checklist del modal personalizado
            async function cargarServiciosPersonalizados() {
                const contenedor = document.getElementById("servPersonalizados");
                contenedor.innerHTML = `<p class="text-center">Cargando servicios...</p>`;

                try {
                    const ref = collection(db, "productos"); // servicios = productos
                    const qServicios = query(ref, orderBy("nombre", "asc"));

                    onSnapshot(qServicios, (snapshot) => {
                        contenedor.innerHTML = ""; // limpiar

                        if (snapshot.empty) {
                            contenedor.innerHTML = `<p class="text-center text-muted">No hay servicios registrados</p>`;
                            return;
                        }

                        snapshot.forEach((doc) => {
                            const data = doc.data();

                            const item = `
                                <div class="form-check">
                                    <input class="form-check-input" 
                                          type="checkbox" 
                                          value="${doc.id}" 
                                          id="serv-${doc.id}">
                                    <label class="form-check-label" for="serv-${doc.id}">
                                        ${data.nombre}
                                    </label>
                                </div>
                            `;
                            contenedor.innerHTML += item;
                        });
                    });

                } catch (e) {
                    contenedor.innerHTML = `<p class="text-danger">Error al cargar servicios</p>`;
                    console.error("Error cargando servicios:", e);
                }
            }

            // Detectar cuando se abre el modal y cargar servicios
            const personalizadoModal = document.getElementById("personalizadoModal");

            personalizadoModal.addEventListener("show.bs.modal", () => {
                cargarServiciosPersonalizados();
                llenarFormularioPaquete(); // rellenar datos autom√°ticamente
            });

            async function obtenerNombreServicios(ids) {
                if (!Array.isArray(ids)) return [];

                const nombres = [];

                for (const id of ids) {
                    try {
                        const ref = doc(db, "productos", id);
                        const snap = await getDoc(ref);
                        if (snap.exists()) {
                            nombres.push(snap.data().nombre);
                        } else {
                            nombres.push("Servicio no encontrado");
                        }
                    } catch (e) {
                        nombres.push("Error");
                    }
                }
                return nombres;
            }

            onSnapshot(qPaquetes, async snapshotPaquetes => {
                const paquetesPromises = snapshotPaquetes.docs.map(async docSnap => {
                    const data = docSnap.data();
                    const serviciosIds = data.servicios || [];
                    const nombresServicios = await obtenerNombreServicios(serviciosIds);

                    return {
                        id: docSnap.id,
                        tipo: 'paquete',
                        nombre: data.nombre || 'Sin nombre',
                        precio: Number(data.precio) || 0,
                        descripcion: data.descripcion || 'Sin descripci√≥n',
                        imagenes: data.imagenes || [],
                        imagenUrl: (data.imagenUrl || data.imagenes?.[0]) + `?v=${data.updatedAt?.toMillis?.() || Date.now()}`,
                        servicios: serviciosIds,
                        serviciosNombres: nombresServicios,
                        stock: Number(data.stock) || 0,
                        createdAt: data.createdAt || null
                    };
                });

                paquetesCache = await Promise.all(paquetesPromises);

                productosData = mergeAndSort(productosCache, paquetesCache);
                renderProductos(productosData);
                localStorage.setItem('productosCache', JSON.stringify(productosData));
            });

        }

        // Funci√≥n para mezclar y ordenar por createdAt m√°s reciente arriba
        function mergeAndSort(lista1 = [], lista2 = []) {
            return [...lista1, ...lista2].sort((a, b) => {
                const timeA = a.createdAt?.toMillis?.() || 0;
                const timeB = b.createdAt?.toMillis?.() || 0;
                return timeB - timeA; // ‚Üì m√°s nuevo arriba
            });
        }

        function mostrarSinConexion() {
            productosDiv.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="alert alert-warning">
                        <i class="bi bi-wifi-off display-4"></i>
                        <h4 class="mt-3">Sin conexi√≥n</h4>
                        <p>No hay datos cacheados disponibles.</p>
                        <p>Con√©ctate a internet para cargar productos por primera vez.</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Reintentar
                        </button>
                        <a href="index.html" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-house"></i> Volver al Inicio
                        </a>
                    </div>
                </div>
            `;
        }

        function renderProductos(productos) {
    productosDiv.innerHTML = '';
    if (productos.length === 0) {
        productosDiv.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle display-4"></i>
                    <h4 class="mt-3">No hay productos disponibles</h4>
                    <a href="index.html" class="btn btn-outline-secondary">Volver al Inicio</a>
                </div>
            </div>
        `;
        return;
    }
    
    productos.forEach(producto => {
        const div = document.createElement("div");
        div.classList.add("col-md-4", "mb-4");
        
        const imagenesHTML = producto.imagenes && producto.imagenes.length > 1 
            ? `<div class="thumb-grid">
                ${producto.imagenes.slice(0, 4).map(url => 
                `<img src="${url}" class="thumb" style="cursor:pointer"
                        onclick="verImagen('${url}')" 
                        alt="${producto.nombre}">`
                ).join('')}
                ${producto.imagenes.length > 4 ? `<div class="thumb bg-light text-center d-flex align-items-center justify-content-center">
                <small>+${producto.imagenes.length - 4}</small>
                </div>` : ''}
            </div>` : '';

        const borderColor = producto.tipo === 'producto' ? '#b330ff' : '#17ff3e';

        // Para productos: mostrar responsable, para paquetes: mostrar servicios
        let detalle = '';
        if (producto.tipo === 'producto') {
            detalle = producto.responsable || 'Sin responsable';
        } else if (producto.tipo === 'paquete') {
            detalle = Array.isArray(producto.serviciosNombres)
            ? producto.serviciosNombres.join(', ')
            : 'Sin servicios';
        }

        div.innerHTML = `
    <div class="card h-100 shadow-sm"
        style="background-color: transparent; border: 2px solid ${borderColor}; color: white">
        <img src="${producto.imagenUrl}" 
            class="product-img card-img-top"
            style="cursor:pointer"
            onclick="verImagen('${producto.imagenUrl}')"
            alt="${producto.nombre}"
            onerror="this.src='https://via.placeholder.com/300x200?text=Imagen+No+Disponible'">
        ${imagenesHTML}
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">${producto.nombre}</h5>
            <p class="card-text flex-grow-1">${producto.descripcion}</p>
            <p class="card-text">
                <strong style="color: #b330ff;" class="h5">$${producto.precio.toFixed(2)}</strong>
            </p>
            <p class="card-text"><strong>Ubicaci√≥n:</strong> ${producto.ubicacion || "No especificada"}</p>
            <p class="card-text">
                <small class="text-light">
                    <i class="card-text"></i> ${detalle} |
                </small>
            </p>
            <div class="mt-auto">
                <input type="number" 
                    min="1" 
                    value="1" 
                    id="cantidad-${producto.id}" 
                    class="form-control mb-2"
                    placeholder="Cantidad">
                <button class="btn btn-primary w-100 mb-2" 
                        onclick="agregarAlCarrito('${producto.id}')">
                    <i class="bi bi-cart-plus"></i> A√±adir al Carrito
                </button>

                ${producto.tipo === 'producto' && producto.agenda ? `
                    <button class="btn w-100 custom-reservar-btn"
                        onclick="openBookingModal('${producto.id}')">
                        <i class="bi bi-calendar-event"></i> Reservar cita
                    </button>
                ` : ``}
            </div>
        </div>
    </div>
`;
        
        productosDiv.appendChild(div);

        // Mostrar bot√≥n para paquete personalizado si se seleccion√≥ solo paquetes
        const filtroTipo = document.getElementById("filterTipo").value;
        const paqueteContainer = document.getElementById("paquetePersonalizadoContainer");

        if (filtroTipo === "paquete") {
            paqueteContainer.innerHTML = `
                <button id="btnPaquetePersonalizado" class="btn w-75 py-2" 
                        onclick="solicitarPaquetePersonalizado()">
                    <i class="bi bi-pencil-square"></i> Solicitar Paquete Personalizado
                </button>
            `;
        } else {
            paqueteContainer.innerHTML = ""; // ocultar si no es paquete
        }

    });
    window.solicitarPaquetePersonalizado = function() {
        const modal = new bootstrap.Modal(document.getElementById("personalizadoModal"));
        modal.show();
    };
    }

        window.agregarAlCarrito = function(id) {
            const producto = productosData.find(p => p.id === id);
            if (!producto) return;

            const cantidadInput = document.getElementById(`cantidad-${id}`);
            const cantidad = parseInt(cantidadInput?.value) || 1;

            let itemExistente = carrito.find(p => p.id === id);

            if (itemExistente) {
                itemExistente.cantidad += cantidad;
            } else {
                carrito.push({
                    id: producto.id,
                    nombre: producto.nombre,
                    precio: producto.precio,
                    imagenUrl: producto.imagenUrl,
                    cantidad: cantidad
                });
            }

            localStorage.setItem("carrito", JSON.stringify(carrito));
            mostrarCarrito();
            updateCartBadge();
            
            showAlert(`${cantidad} x ${producto.nombre} agregado al carrito`, 'success');
            if (cantidadInput) cantidadInput.value = 1;
        }

        function mostrarCarrito() {
    carritoUl.innerHTML = "";
    let total = 0;

    if (carrito.length === 0) {
        carritoUl.innerHTML = `
            <li class="list-group-item text-center text-muted py-5">
                <i class="bi bi-cart-x display-1"></i>
                <p class="mt-3 h5">Tu carrito est√° vac√≠o</p>
                <p class="text-muted">Agrega algunos productos desde la tienda</p>
                <a href="#" class="btn btn-primary" data-bs-dismiss="offcanvas">
                    <i class="bi bi-arrow-left"></i> Seguir Comprando
                </a>
            </li>
        `;
        totalSpan.textContent = "0.00";
        return;
    }

    carrito.forEach((item, index) => {
        const productoData = productosData.find(p => p.id === item.id);
        const tipo = productoData?.tipo || 'producto'; // "producto" o "paquete"
        const borderColor = tipo === 'paquete' ? '#17ff3e' : '#b330ff';

        const subtotal = item.precio * item.cantidad;
        total += subtotal;

        const li = document.createElement("li");
        li.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center", "tipo-item");
        li.style.borderLeft = `5px solid ${borderColor}`; // diferenciaci√≥n visual

        li.innerHTML = `
            <div class="d-flex align-items-center flex-grow-1">
                <img src="${item.imagenUrl}" 
                     class="cart-item-img me-3" 
                     alt="${item.nombre}"
                     onerror="this.src='https://via.placeholder.com/50x50?text=Img'">
                <div class="flex-grow-1">
                    <strong class="d-block">${item.nombre}</strong>
                    <small class="text-muted">${item.cantidad} x $${item.precio.toFixed(2)}</small>
                    <span class="badge" style="background:${borderColor}; color:#0f141f;">${tipo === 'paquete' ? 'Paquete' : 'Servicio'}</span>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">$${subtotal.toFixed(2)}</span>
                <button class="btn btn-outline-danger btn-sm" onclick="eliminarDelCarrito(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        carritoUl.appendChild(li);
    });

    totalSpan.textContent = total.toFixed(2);
}


        window.eliminarDelCarrito = function(index) {
            const item = carrito[index];
            if (confirm(`¬øEliminar ${item.cantidad} x ${item.nombre} del carrito?`)) {
                carrito.splice(index, 1);
                localStorage.setItem("carrito", JSON.stringify(carrito));
                mostrarCarrito();
                updateCartBadge();
            }
        }

        function updateCartBadge() {
            const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            cartBadge.textContent = totalItems;
            cartBadge.classList.toggle('d-none', totalItems === 0);
        }

        limpiarBtn.addEventListener("click", () => {
            if (carrito.length === 0) return;
            
            if (confirm('¬øVaciar todo el carrito y regresar al inicio?')) {
                carrito = [];
                localStorage.removeItem("carrito");
                mostrarCarrito();
                updateCartBadge();
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        });

        pagarBtn.addEventListener("click", () => {
            if (carrito.length === 0) {
                alert("Tu carrito est√° vac√≠o");
                return;
            }
            
            const total = totalSpan.textContent;
            const resumen = carrito.map(item => 
                `‚Ä¢ ${item.cantidad}x ${item.nombre} - $${(item.precio * item.cantidad).toFixed(2)}`
            ).join('\n');
            
            if (confirm(`**Resumen de Compra**\n\n${resumen}\n\nüí∞ **Total: $${total}**\n\n¬øConfirmar compra?`)) {
                alert('¬°Compra realizada con √©xito! Gracias por tu compra.');
                
                carrito = [];
                localStorage.removeItem("carrito");
                mostrarCarrito();
                updateCartBadge();
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        cargarProductos();
        mostrarCarrito();
        updateCartBadge();

            window.verImagen = function (url) {
        const producto = productosData.find(p => p.imagenes.includes(url) || p.imagenUrl === url);
        const imagenes = producto.imagenes?.length > 0 ? producto.imagenes : [url];

        const carouselInner = document.getElementById("carousel-images");
        carouselInner.innerHTML = "";

        imagenes.forEach((img, index) => {
            carouselInner.innerHTML += `
                <div class="carousel-item ${index === 0 ? 'active' : ''}">
                    <img src="${img}" class="d-block w-100 rounded" style="max-height: 80vh; object-fit: contain;">
                </div>
            `;
        });

        const modal = new bootstrap.Modal(document.getElementById("imageModal"));
        modal.show();
    };

    // ENVIAR SOLICITUD DE PAQUETE
    const formPaquete = document.getElementById("personalizadoForm");
    const spinnerPaquete = document.getElementById("submitSpinnerPaquete");
    const btnSubmitPaquete = document.getElementById("submitBtnPaquete");

    formPaquete.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Activar spinner
        spinnerPaquete.classList.remove("d-none");
        btnSubmitPaquete.disabled = true;

        // Obtener servicios seleccionados
        const serviciosSeleccionados = [];
        document.querySelectorAll("#servPersonalizados input[type='checkbox']:checked")
            .forEach(chk => serviciosSeleccionados.push(chk.value));

        const otrosServicios = document.getElementById("servOtro").value.trim();

        // Crear objeto para guardar en Firestore
        const userStorage = JSON.parse(localStorage.getItem("stratifyUser"));

        const solicitudData = {
            uid: userStorage.uid,
            nombrePersona: document.getElementById("persNombre").value,
            telefono: document.getElementById("persTelefono").value,
            correo: document.getElementById("persCorreo").value,
            nombreEmpresa: document.getElementById("empNombre").value,
            areaEmpresa: document.getElementById("empArea").value,
            descripcionEmpresa: document.getElementById("empDescripcion").value,
            serviciosRequeridos: serviciosSeleccionados,
            otrosServicios: otrosServicios,
            fecha: new Date(),
            estatus: "enviada" 
        };

        try {
            await addDoc(collection(db, "solicitudes"), solicitudData);

            // Notificaci√≥n de √©xito
            showAlert("Tu solicitud fue enviada exitosamente. Pronto te contactaremos.", "success");

            // Limpiar formulario
            formPaquete.reset();

            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById("personalizadoModal"));
            modal.hide();

        } catch (err) {
            console.error("Error al enviar solicitud:", err);
            showAlert("Ocurri√≥ un error al enviar la solicitud.", "danger");
        }

        // Desactivar spinner
        spinnerPaquete.classList.add("d-none");
        btnSubmitPaquete.disabled = false;
    });

    // Variable para producto actual en reserva
    let currentBookingProductId = null;

    // Abre modal y setea nombre del producto
    window.openBookingModal = function(productId) {
        const producto = productosData.find(p => p.id === productId);
        if (!producto) {
            showAlert("Producto no encontrado", "danger");
            return;
        }

        currentBookingProductId = productId;
        document.getElementById("bookingProductName").textContent = producto.nombre;
        document.getElementById("bookingDatetime").value = ""; // limpiar
        document.getElementById("bookingComment").value = "";

        const bookingModalEl = document.getElementById("bookingModal");
        const bookingModal = new bootstrap.Modal(bookingModalEl);
        bookingModal.show();
    };

    // Manejar submit de reserva
    const bookingForm = document.getElementById("bookingForm");
    bookingForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentBookingProductId) {
            showAlert("Producto inv√°lido", "danger");
            return;
        }

        const datetimeValue = document.getElementById("bookingDatetime").value;
        const comment = document.getElementById("bookingComment").value.trim();

        if (!datetimeValue) {
            showAlert("Selecciona fecha y hora", "warning");
            return;
        }

        // convertir a Date
        const fechaSeleccionada = new Date(datetimeValue);
        if (isNaN(fechaSeleccionada.getTime())) {
            showAlert("Fecha inv√°lida", "danger");
            return;
        }

        // Obtener usuario actual del localStorage
        const userStorage = JSON.parse(localStorage.getItem("stratifyUser"));
        if (!userStorage || !userStorage.uid) {
            showAlert("Debes iniciar sesi√≥n para reservar", "warning");
            return;
        }

        // Desactivar bot√≥n temporalmente
        const submitBtn = document.getElementById("bookingSubmitBtn");
        submitBtn.disabled = true;
        submitBtn.textContent = "Reservando...";

        try {
            // Guardar en Firestore -> colecci√≥n "citas"
            await addDoc(collection(db, "citas"), {
                uid: userStorage.uid,
                productId: currentBookingProductId,
                fecha: fechaSeleccionada,
                comentario: comment || "",
                estatus: "pendiente",
                createdAt: new Date()
            });

            showAlert("Cita reservada. Te contactaremos para confirmar.", "success");

            // Cerrar modal
            const bookingModalInstance = bootstrap.Modal.getInstance(document.getElementById("bookingModal"));
            bookingModalInstance.hide();

        } catch (err) {
            console.error("Error guardando cita:", err);
            showAlert("No se pudo reservar la cita. Intenta de nuevo.", "danger");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Reservar";
            currentBookingProductId = null;
        }
    });

    </script>

        <!-- Modal con carrusel -->
    <div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background:#0f141f; border: 2px solid #b330ff;">
        <div class="modal-header">
            <h5 class="modal-title" style="color:#eb01c2;">Vista de im√°genes</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>

        </div>

        <div class="modal-body">
            <div id="carouselProducto" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner" id="carousel-images"></div>

            <!-- Controles -->
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselProducto" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselProducto" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>
            </div>
        </div>

        </div>
    </div>
    </div>
    <!-- Offcanvas Solicitudes -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="solicitudesOffcanvas" style="background:#0f141f; color:white; border: 2px solid #17ff3e;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" style="color:#17ff3e;">Mis Solicitudes</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <ul id="lista-solicitudes" class="list-group"></ul>
        </div>
    </div>

    <!-- Modal Reservar Cita -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#0f141f; color:white; border:2px solid #b330ff;">
        <div class="modal-header">
            <h5 class="modal-title" id="bookingModalTitle" style="color:#17ff3e;">Reservar cita</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="bookingForm">
            <div class="modal-body">
            <p id="bookingProductName" class="mb-2" style="color: #eb01c2;"></p>
            <div class="mb-3">
                <label class="form-label">Selecciona fecha y hora</label>
                <input id="bookingDatetime" class="form-control" type="datetime-local" required />
                <div class="form-text">Selecciona fecha y hora disponible para la cita.</div>
            </div>
            <div class="mb-3">
                <label class="form-label">Comentario (opcional)</label>
                <textarea id="bookingComment" class="form-control" rows="2" placeholder="Detalles extra..."></textarea>
            </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success" id="btnPaquetePersonalizado">Reservar</button>
            </div>
        </form>
        </div>
    </div>
    </div>

</body>
<footer class="mt-5 p-4 text-center" 
        style="background:#0F141F; border-top:2px solid #17ff3e; color:white;">
    <h5 style="color:#b330ff;">Contacto Stratify</h5>
    <p class="mb-1">
        <i class="bi bi-envelope-fill" style="color:#eb01c2;"></i>
        contacto@stratify.com
    </p>
    <p class="mb-1">
        <i class="bi bi-telephone-fill" style="color:#17ff3e;"></i>
        +52 555 123 4567
    </p>
    <p class="mb-3">
        <i class="bi bi-instagram" style="color:#009bfa;"></i>
        @stratify.digital
    </p>
    <small style="color:#888;">¬© 2025 Stratify ‚Äî Impulso Digital</small>
    <small style="color:#888;">¬© 2025 TechTitans</small>
</footer>
</html>